name: 'Push to GCR'
description: 'Build a docker container and publish it to Google Container Registry.'
inputs:
  google-email:
    description: 'Email to authentite gcloud'
    required: true
  google-key:
    description: 'Key to authenticate gcloud'
    required: true
  google-project:
    description: 'GCP project to use'
    required: false
    default: 'tilda-production'
outputs:
  image:
    description: "Build docker image"
    value: gcr.io/${{ inputs.google-project }}/${{ steps.repo-name.outputs.replaced }}:${{ github.event.pull_request.head.sha || github.sha }}
runs:
  using: "composite"
  steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Repo Name
      id: repo-name
      uses: frabert/replace-string-action@v2.0
      with:
        string: ${{ github.repository }}
        pattern: ${{ github.repository_owner }}/
        replace-with: ''

    # Setup gcloud CLI
    - uses: google-github-actions/setup-gcloud@master
      with:
        version: '270.0.0'
        service_account_email: ${{ inputs.google-email }}
        service_account_key: ${{ inputs.google-key }}

    # Configure docker to use the gcloud command-line tool as a credential helper
    - run: gcloud auth configure-docker
      shell: bash

    - name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@master

    - name: Cache Docker layers
      uses: actions/cache@v2
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.event.pull_request.head.sha || github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-

    - name: Build and push
      id: docker_build
      uses: docker/build-push-action@v2
      with:
        context: ./
        file: ./Dockerfile
        builder: ${{ steps.buildx.outputs.name }}
        push: true
        tags: gcr.io/${{ inputs.google-project }}/${{ steps.repo-name.outputs.replaced }}:${{ github.event.pull_request.head.sha || github.sha }}
        cache-from: type=local,src=/tmp/.buildx-cache
        cache-to: type=local,dest=/tmp/.buildx-cache

